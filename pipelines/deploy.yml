- pipeline: "Deploy"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/master"
  fail_on_prepare_env_warning: true
  resources: "NANO"
  actions:
  - action: "npm run build"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "18"
    execute_commands:
    - "npm install"
    shell: "BASH"
  - action: "php bin/console assets:install"
    type: "BUILD"
    docker_image_name: "library/php"
    docker_image_tag: "8.2"
    execute_commands:
    - "composer validate"
    - "composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist --no-dev --optimize-autoloader"
    - "composer dump-env prod"
    - "php bin/console cache:clear --no-warmup"
    - "php bin/console assets:install"
    - "# vendor/bin/phpunit"
    setup_commands:
    - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - ""
    - "# php ext gd"
    - "apt-get install -y libfreetype6-dev"
    - "apt-get install -y libjpeg62-turbo-dev"
    - "apt-get install -y libpng-dev"
    - "docker-php-ext-configure gd --with-freetype --with-jpeg"
    - "docker-php-ext-install gd"
    - ""
    - "# php ext pdo_mysql"
    - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
    - "docker-php-ext-install pdo_mysql"
    - ""
    - "# php ext zip"
    - "apt-get install -y zip"
    - "apt-get install -y unzip"
    - "apt-get install -y zlib1g-dev"
    - "apt-get install -y libzip-dev"
    - "docker-php-ext-install zip"
    shell: "BASH"
